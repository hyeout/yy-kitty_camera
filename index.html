<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0; display: flex; justify-content: center; align-items: center;
            background-color: transparent; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
            user-select: none; min-height: 100vh;
        }

        /* [Í∏∞Ï°¥ Ïú†ÏßÄ] ÎπÑÏú® Í≥†Ï†ï Ïª®ÌÖåÏù¥ÎÑà */
        .widget-container {
            position: relative;
            width: 95vw;
            max-width: 450px;
            aspect-ratio: 1 / 1;
        }

        /* [Ï∂îÍ∞Ä] Ïò®Î≥¥Îî© ÏÑ§Ï†ï Î†àÏù¥Ïñ¥ */
        #onboarding-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100; display: none; padding: 25px;
            box-sizing: border-box; border-radius: 15px; border: 2px solid #ffb6c1;
        }
        .onboarding-content h1 { font-size: 18px; color: #ff8a8a; margin-bottom: 15px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 12px; }
        .start-btn { width: 100%; padding: 12px; background: #ffb6c1; border: none; color: white; font-weight: bold; border-radius: 8px; cursor: pointer; }
        .tip-box { background: #fff5f7; padding: 10px; font-size: 11px; margin-top: 15px; border-radius: 5px; color: #666; }

        /* [Í∏∞Ï°¥ Ïú†ÏßÄ] Ïπ¥Î©îÎùº Î≥∏Ï≤¥ Î∞è ÌôîÎ©¥ */
        .camera-body { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0; z-index: 10; transition: opacity 0.3s; }
        .camera-body.active { opacity: 1; }

        #screen {
            position: absolute; top: 29.2%; left: 20.1%; 
            width: calc(37.4% + 8px); height: 32.2%;
            overflow: hidden; display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 5; border-radius: 3px; background-color: #f7f7f7;
        }

        #uploaded-img {
            position: absolute; height: 110%; width: auto;
            max-width: none; max-height: none; cursor: grab; display: none;
            transition: filter 0.2s ease;
        }

        .plus-icon { font-size: clamp(10px, 3vw, 14px); text-align: center; font-weight: 500; color: #9abedb; pointer-events: none; }

        /* [Í∏∞Ï°¥ Ïú†ÏßÄ] Ï¥àÏ†ïÎ∞Ä Î≤ÑÌäº Ï¢åÌëú */
        .btn { position: absolute; cursor: pointer; z-index: 20; background-color: transparent; }
        .btn-ok { top: calc(53.2% - 20px); left: calc(76.5% - 14px); width: 5%; height: 5%; border-radius: 50%; }
        .btn-up { top: calc(45.4% - 20px); left: calc(76.5% - 14px); width: 5%; height: 6%; }
        .btn-down { top: calc(61.1% - 20px); left: calc(76.5% - 14px); width: 5%; height: 6%; }
        .btn-left { top: calc(53.2% - 20px); left: calc(68.8% - 14px); width: 6%; height: 5%; }
        .btn-right { top: calc(53.2% - 20px); left: calc(84.2% - 14px); width: 6%; height: 5%; }
        .btn-move { top: calc(69.1% - 20px); left: calc(71.5% - 14px); width: 14%; height: 4.5%; border-radius: 10px; }

        #status-tip { position: absolute; bottom: 12%; left: 50%; transform: translateX(-50%); color: white; padding: 6px 18px; border-radius: 20px; font-size: 12px; display: none; z-index: 30; white-space: nowrap; }
        #file-input { display: none; }
    </style>
</head>
<body>

<div class="widget-container">
    <div id="onboarding-layer">
        <div class="onboarding-content">
            <h1>üéÄ Kitty Camera ÏÑ§Ï†ï</h1>
            <div class="input-group">
                <label>Notion API ÌÜ†ÌÅ∞</label>
                <input type="password" id="notion-token" placeholder="ntn_ÏúºÎ°ú ÏãúÏûëÌïòÎäî ÌÜ†ÌÅ∞ ÏûÖÎ†•">
            </div>
            <div class="input-group">
                <label>Database ID</label>
                <input type="text" id="notion-dbid" placeholder="DB ID(32ÏûêÎ¶¨ Î¨∏ÏûêÏó¥) ÏûÖÎ†•">
            </div>
            <button class="start-btn" onclick="saveOnboarding()">ÏÑ§Ï†ï ÏôÑÎ£åÌïòÍ∏∞</button>
            <div class="tip-box">
                üí° Ï§ëÏöî: ÎÖ∏ÏÖò DB ÌéòÏù¥ÏßÄ Ïö∞Ï∏° ÏÉÅÎã® '...' -> 'Ïó∞Í≤∞ Ï∂îÍ∞Ä'ÏóêÏÑú ÎßåÎì† APIÎ•º Ïó∞Í≤∞ÌñàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî!
            </div>
        </div>
    </div>

    <img src="kitty_camera_blue.png" id="cam-blue" class="camera-body active">
    <img src="kitty_camera_pink.png" id="cam-pink" class="camera-body">
    <img src="kitty_camera_red.png" id="cam-red" class="camera-body">

    <div id="screen" onclick="triggerUpload()">
        <div class="plus-icon" id="placeholder">click to upload ‚ô°</div>
        <img id="uploaded-img" src="" draggable="false">
    </div>

    <div class="btn btn-ok" onclick="switchColor()" title="ÌÖåÎßà Î≥ÄÍ≤Ω"></div>
    <div class="btn btn-move" onclick="toggleMoveMode()" title="ÏÇ¨ÏßÑ Ïù¥Îèô"></div>
    <div class="btn btn-up" onclick="adjustFilter('bright', 10)"></div>
    <div class="btn btn-down" onclick="adjustFilter('bright', -10)"></div>
    <div class="btn btn-left" onclick="adjustFilter('contrast', -10)"></div>
    <div class="btn btn-right" onclick="adjustFilter('contrast', 10)"></div>

    <div id="status-tip"></div>
</div>

<input type="file" id="file-input" accept="image/*" onchange="previewImage(event)">

<script>
    let token = localStorage.getItem('kitty_token');
    let dbId = localStorage.getItem('kitty_dbid');

    const themes = [
        { id: 'blue', color: '#9abedb', tipBg: 'rgba(154, 190, 219, 0.95)' },
        { id: 'pink', color: '#ffb6c1', tipBg: 'rgba(255, 182, 193, 0.95)' },
        { id: 'red',  color: '#ff8a8a', tipBg: 'rgba(255, 138, 138, 0.95)' }
    ];
    let currentIndex = 0, brightness = 100, contrast = 100, isMoveMode = false, isDragging = false;
    let startX, startY, translateX = 0, translateY = 0;

    const img = document.getElementById('uploaded-img');
    const screen = document.getElementById('screen');
    const tip = document.getElementById('status-tip');
    const placeholder = document.getElementById('placeholder');

    // [ÏàòÏ†ï] Ï¥àÍ∏∞ Ïã§Ìñâ Ïãú ÎÖ∏ÏÖò DB Ïó∞Îèô Ï≤¥ÌÅ¨
    window.onload = function() {
        if (!token || !dbId) {
            document.getElementById('onboarding-layer').style.display = 'block';
        } else {
            loadFromNotion();
        }
    }

    function saveOnboarding() {
        const t = document.getElementById('notion-token').value;
        const d = document.getElementById('notion-dbid').value;
        if (!t || !d) return alert("Ï†ïÎ≥¥Î•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");
        localStorage.setItem('kitty_token', t);
        localStorage.setItem('kitty_dbid', d);
        location.reload();
    }

    // [Ï∂îÍ∞Ä] ÎÖ∏ÏÖò ÌÜµÏã† Ìï®Ïàò
    async function syncWithNotion(method, data = {}) {
        try {
            const res = await fetch('/api/notion', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, dbId, method, data })
            });
            return await res.json();
        } catch (e) { console.error("ÎÖ∏ÏÖò ÎèôÍ∏∞Ìôî Ïã§Ìå®:", e); }
    }

    async function loadFromNotion() {
        showTip("Syncing with Notion...");
        const result = await syncWithNotion('GET');
        if (result && result.results && result.results.length > 0) {
            const page = result.results[0].properties;
            if (page.ImageURL.rich_text.length > 0) {
                img.src = page.ImageURL.rich_text[0].text.content;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            }
            translateX = page.X.number || 0;
            translateY = page.Y.number || 0;
            brightness = page.Bright.number || 100;
            contrast = page.Contrast.number || 100;
            
            // ÌÖåÎßà Ï†ÅÏö©
            const savedTheme = page.Theme.rich_text[0]?.text.content || 'blue';
            applySavedTheme(savedTheme);
            updateTransform();
            img.style.filter = `brightness(${brightness}%) contrast(${contrast}%)`;
        }
    }

    async function saveToNotion() {
        const data = {
            img: img.src, x: translateX, y: translateY,
            bright: brightness, contrast: contrast,
            theme: themes[currentIndex].id
        };
        await syncWithNotion('SAVE', data);
        showTip("Saved to Notion ‚ú®");
    }

    // [Í∏∞Ï°¥ Ïú†ÏßÄ] ÌÖåÎßà Î∞è ÌïÑÌÑ∞ Î°úÏßÅ
    function switchColor() {
        document.getElementById(`cam-${themes[currentIndex].id}`).classList.remove('active');
        currentIndex = (currentIndex + 1) % themes.length;
        document.getElementById(`cam-${themes[currentIndex].id}`).classList.add('active');
        placeholder.style.color = themes[currentIndex].color;
        showTip(`Theme: ${themes[currentIndex].id.toUpperCase()}`);
        saveToNotion();
    }

    function applySavedTheme(themeId) {
        document.getElementById(`cam-${themes[currentIndex].id}`).classList.remove('active');
        currentIndex = themes.findIndex(t => t.id === themeId);
        if(currentIndex === -1) currentIndex = 0;
        document.getElementById(`cam-${themes[currentIndex].id}`).classList.add('active');
        placeholder.style.color = themes[currentIndex].color;
    }

    function toggleMoveMode() {
        if (!img.src || img.style.display === 'none') return;
        isMoveMode = !isMoveMode;
        if (isMoveMode) {
            showTip("MOVE MODE: ON");
            screen.style.cursor = 'move'; img.style.pointerEvents = 'auto';
        } else {
            showTip("MOVE MODE: OFF");
            screen.style.cursor = 'pointer'; img.style.pointerEvents = 'none';
            saveToNotion(); // Ïù¥Îèô Ï¢ÖÎ£å Ïãú Ï†ÄÏû•
        }
    }

    function adjustFilter(type, value) {
        if (!img.src || img.style.display === 'none') return;
        if (type === 'bright') brightness += value;
        if (type === 'contrast') contrast += value;
        img.style.filter = `brightness(${brightness}%) contrast(${contrast}%)`;
        showTip(`Bright: ${brightness}% | Contrast: ${contrast}%`);
        saveToNotion();
    }

    function showTip(text) {
        tip.innerText = text;
        tip.style.background = themes[currentIndex].tipBg;
        tip.style.display = 'block';
        clearTimeout(window.tipTimeout);
        window.tipTimeout = setTimeout(() => { tip.style.display = 'none'; }, 2000);
    }

    function triggerUpload() { if (!isMoveMode) document.getElementById('file-input').click(); }

    function previewImage(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function() {
            img.src = reader.result;
            img.style.display = 'block';
            placeholder.style.display = 'none';
            brightness = 100; contrast = 100; translateX = 0; translateY = 0;
            updateTransform();
            saveToNotion(); // ÏóÖÎ°úÎìú Ïãú Ï†ÄÏû•
        }
        if (file) reader.readAsDataURL(file);
    }

    screen.addEventListener('mousedown', (e) => { if (isMoveMode) { isDragging = true; startX = e.clientX - translateX; startY = e.clientY - translateY; } });
    window.addEventListener('mousemove', (e) => { if (isDragging) { translateX = e.clientX - startX; translateY = e.clientY - startY; updateTransform(); } });
    window.addEventListener('mouseup', () => { isDragging = false; });
    function updateTransform() { img.style.transform = `translate(${translateX}px, ${translateY}px)`; }
</script>

</body>
</html>
